<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Overview</title>
    <!-- Include Bootstrap CSS (optional) -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include ApexCharts CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts/dist/apexcharts.css">
    <style>
        #report-chart1 {
            height: 350px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-6">
                <div class="card card-block card-stretch card-height">
                    <div class="card-header d-flex justify-content-between">
                        <div class="header-title">
                            <h4 class="card-title">Overview</h4>
                        </div>
                        <div class="card-header-toolbar d-flex align-items-center">
                            <div class="dropdown">
                                <span class="dropdown-toggle dropdown-bg btn" id="dropdownMenuButton1" data-toggle="dropdown">
                                    This Month<i class="ri-arrow-down-s-line ml-1"></i>
                                </span>
                                <div class="dropdown-menu dropdown-menu-right shadow-none" aria-labelledby="dropdownMenuButton1">
                                    <a class="dropdown-item" id="filter-year" href="#">Year</a>
                                    <a class="dropdown-item" id="filter-month" href="#">Month</a>
                                    <a class="dropdown-item" id="filter-week" href="#">Week</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="report-chart1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Include Bootstrap JS (optional) -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Include ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to fetch chart data from the server based on the time period
            function fetchChartData(period) {
                return fetch(`/project/fetch-chart.php?period=${period}`)  // Pass the selected period
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Debugging: Log data to ensure it's in the expected format
                        console.log('Fetched data:', data);
                        // Process and format the data for the chart
                        return data.map(item => ({
                            x: new Date(item.date),  // Convert date to JavaScript Date object
                            y: period === 'year' || period === 'month' || period === 'week'
                                ? item.total_revenue  // Use total revenue for Y-axis
                                : [item.open, item.high, item.low, item.close]  // Format data for candlestick
                        }));
                    });
            }

            // Initialize the chart options
            const options = {
                chart: {
                    height: 350,
                    type: 'line'  // Default to line chart; will be updated if period requires candlestick
                },
                series: [{
                    name: 'Total Revenue',
                    data: []  // Initially empty, will be populated with data from the server
                }],
                title: {
                    text: 'Total Revenue Overview',
                    align: 'left'
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        format: 'MMM dd, yyyy'  // Format for displaying dates
                    }
                },
                yaxis: {
                    title: {
                        text: 'Total Revenue'
                    },
                    labels: {
                        formatter: function (value) {
                            return `$${value}`;  // Format Y-axis labels as currency
                        }
                    }
                },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#FF7E41',
                            downward: '#32BDEA'
                        }
                    }
                }
            };

            // Create and render the chart
            const chart = new ApexCharts(document.querySelector("#report-chart1"), options);
            chart.render();

            // Function to update the chart based on the selected period
            function updateChart(period) {
                // Update chart type based on period
                if (period === 'year' || period === 'month' || period === 'week') {
                    chart.updateOptions({
                        chart: {
                            type: 'line'
                        },
                        series: [{
                            name: 'Total Revenue',
                            data: []  // Initially empty
                        }]
                    });
                } else {
                    chart.updateOptions({
                        chart: {
                            type: 'candlestick'
                        },
                        series: [{
                            data: []  // Initially empty
                        }]
                    });
                }

                fetchChartData(period).then(data => {
                    chart.updateOptions({
                        series: [{
                            data: data
                        }]
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
            }

            // Initial load with default period (e.g., Month)
            updateChart('month');

            // Event listeners for dropdown menu items
            document.getElementById('filter-year').addEventListener('click', function() {
                updateChart('year');
            });

            document.getElementById('filter-month').addEventListener('click', function() {
                updateChart('month');
            });

            document.getElementById('filter-week').addEventListener('click', function() {
                updateChart('week');
            });
        });
    </script>
</body>
</html>

